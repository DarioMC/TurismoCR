@using MongoDB.Bson;
@using static System.Convert;
@using Neo4jClient;
@model TurismoCR.Models.Service;

@{
    ViewData["Title"] = "Paquetes Turísticos En Oferta";
    List<Service> enabledServices = ViewBag.enabledServices as List<Service>;
}

<h2>@ViewData["Title"]</h2>
<br>

<table id="t02">
    <thead>
        <th>Nombre</th>
        <th>Descripción</th>
        <th>Categoria</th>
        <th>Provincia</th>
        <th>Cantón</th>
        <th>Distrito</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Precio</th>

		<th>Contacto</th>
		
		<th>Mapa</th>
        <th>Agregar a carrito</th>
    </thead>
    <tbody>
        @foreach (var service in enabledServices) {
            <tr>
                <td>@service.Name</td>
                <td>@service.Description</td>
                <td>@service.Category</td>
                <td>@service.Province</td>
                <td>@service.Canton</td>
                <td>@service.District</td>
                <td>@service.StartDate</td>
                <td>@service.EndDate</td>
                <td>@service.Price</td>
                @* Owner Contact *@
			    @{ 
			        try {
    			        // setting Neo4j connection
                        var client = new GraphClient(
                            // cambiar password (adrian) por el de su base Neo4j
                            new Uri("http://localhost:7474/db/data"), "neo4j", "adrian"
                        );
                        client.Connect();
                        var ownerConsulted = client
                                .Cypher
                                .Match("(userNeo4j:User)")
                                .Where((User userNeo4j) => userNeo4j.UserName == @service.OwnerUsername)
                                .Return(userNeo4j => userNeo4j.As<User>())
                                .Results;
			            if (ownerConsulted.Any()) {
			                var foundOwner = ownerConsulted.First();
			                <td>
                                @foundOwner.Name @foundOwner.LastName1 @foundOwner.LastName2
                                @foundOwner.PhoneNumber
                                @foundOwner.Email
                            </td>
			            } else {
			                <td> No hay datos para mostrar. </td>
			            }
                        
			        } catch {
			            <td> No hay datos para mostrar. </td>
			        }
			    }
			    <td>
                    <p data-placement="top" data-toggle="tooltip" title="Mapa">
                        <a class="btn btn-primary btn-xs" data-title="map" 
                            data-toggle="modal" data-target="#map"
						    onclick="location.href='https://www.google.com/maps/?q=@service.Latitude,@service.Longitude'">
                            Mapa
                        </a>
                    </p>
                </td>
                <td>
                    <p data-placement="top" data-toggle="tooltip" title="Agregar a carrito">
                        <a class="btn btn-primary btn-xs" data-title="AddToCar" 
                            data-toggle="modal" data-target="#addtocar">
                            <span class="glyphicon glyphicon-shopping-cart"></span>
                        </a>
                    </p>
                </td>
            </tr>
        }
    </tbody>
</table>

<style>  
    table#t02 {  
        width: 100%;  
        background-color: #f1f1c1;  
    }
    table#t02 tr:nth-child(even) {  
        background-color: #eee;  
    }  
    table#t02 tr:nth-child(odd) {  
        background-color: #fff;  
    }  
    table#t02 th {  
        color: white;  
        background-color:#50896d;  
    }  
    table, th, td {  
        border: 1px solid black;  
    }  
    table, th, td {  
        border: 1px solid black;  
        border-collapse: collapse;  
    }  
    table, th, td {  
        border: 1px solid black;  
        border-collapse: collapse;  
    }  
    th, td {  
        padding: 15px;
    }  
</style> 
